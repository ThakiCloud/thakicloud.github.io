---
name: Unified Build & Deploy

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUBY_VERSION: '3.2'
  NODE_VERSION: '18'
  DEFAULT_LANGUAGE: 'ko' # 기본 언어 설정

jobs:
  detect-changes:
    name: 🔍 Detect Changes & Plan
    runs-on: ubuntu-latest
    outputs:
      # Language changes
      korean-changed: ${{ steps.changes.outputs.korean }}
      english-changed: ${{ steps.changes.outputs.english }}
      arabic-changed: ${{ steps.changes.outputs.arabic }}
      global-changed: ${{ steps.changes.outputs.global }}

      # Build plan
      should-build: ${{ steps.plan.outputs.should-build }}
      should-deploy: ${{ steps.plan.outputs.should-deploy }}
      should-lint: ${{ steps.plan.outputs.should-lint }}
      build-languages: ${{ steps.plan.outputs.build-languages }}
      build-mode: ${{ steps.plan.outputs.build-mode }}
      deploy-language: ${{ steps.plan.outputs.deploy-language }}
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            korean:
              - '_posts/ko/**'
              - '_pages/ko/**'
              - '_config-ko.yml'
            english:
              - '_posts/en/**'
              - '_pages/en/**'
              - '_config-en.yml'
            arabic:
              - '_posts/ar/**'
              - '_pages/ar/**'
              - '_config-ar.yml'
            global:
              - '_config.yml'
              - '_data/**'
              - '_includes/**'
              - '_layouts/**'
              - '_sass/**'
              - 'assets/**'
              - 'index.html'
              - '.github/workflows/**'
              - 'Gemfile*'

      - name: 📋 Create build plan
        id: plan
        run: |
          KOREAN="${{ steps.changes.outputs.korean }}"
          ENGLISH="${{ steps.changes.outputs.english }}"
          ARABIC="${{ steps.changes.outputs.arabic }}"
          GLOBAL="${{ steps.changes.outputs.global }}"
          IS_MAIN="${{ github.ref == 'refs/heads/main' }}"
          IS_PR="${{ github.event_name == 'pull_request' }}"
          DEFAULT_LANG="${{ env.DEFAULT_LANGUAGE }}"

          echo "🔧 Planning build strategy..."
          echo "  Korean: $KOREAN | English: $ENGLISH | Arabic: $ARABIC"
          echo "  Global: $GLOBAL | Main branch: $IS_MAIN | PR: $IS_PR"
          echo "  Default language: $DEFAULT_LANG"
          
          # 빌드 언어 결정 로직 개선
          BUILD_LANGUAGES=""
          if [[ "$GLOBAL" == "true" ]]; then
            BUILD_LANGUAGES="ko,en,ar"
            BUILD_MODE="full"
            echo "🔄 Global changes - building all languages"
          else
            BUILD_MODE="incremental"
            # 변경된 언어만 빌드 목록에 추가
            [[ "$KOREAN" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}ko,"
            [[ "$ENGLISH" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}en,"
            [[ "$ARABIC" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}ar,"
            BUILD_LANGUAGES=${BUILD_LANGUAGES%,}

            # 빌드할 언어가 없으면 기본 언어 사용
            if [[ -z "$BUILD_LANGUAGES" ]]; then
              BUILD_LANGUAGES="$DEFAULT_LANG"
              echo "⚡ No specific changes, defaulting to $DEFAULT_LANG"
            else
              echo "⚡ Incremental build for: $BUILD_LANGUAGES"
            fi
          fi

          # 배포 언어 결정 (기본 언어 우선, 없으면 첫 번째)
          DEPLOY_LANGUAGE="$DEFAULT_LANG"
          if [[ "$BUILD_LANGUAGES" != *"$DEFAULT_LANG"* ]]; then
            DEPLOY_LANGUAGE=$(echo "$BUILD_LANGUAGES" | cut -d',' -f1)
            echo "⚠️ Default language not in build list, using $DEPLOY_LANGUAGE for deployment"
          fi

          # Set outputs
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "should-deploy=$IS_MAIN" >> $GITHUB_OUTPUT
          echo "should-lint=true" >> $GITHUB_OUTPUT
          echo "build-languages=$BUILD_LANGUAGES" >> $GITHUB_OUTPUT
          echo "build-mode=$BUILD_MODE" >> $GITHUB_OUTPUT
          echo "deploy-language=$DEPLOY_LANGUAGE" >> $GITHUB_OUTPUT

          echo "📋 Build plan:"
          echo "  Languages: $BUILD_LANGUAGES"
          echo "  Mode: $BUILD_MODE"
          echo "  Deploy language: $DEPLOY_LANGUAGE"
          echo "  Will deploy: $IS_MAIN"

  # Fast linting job that runs in parallel
  lint:
    name: 🧹 Quick Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-lint == 'true'
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 💎 Setup Ruby (with cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: 📦 Setup Node.js (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 🧹 Jekyll doctor
        run: bundle exec jekyll doctor

      - name: 📝 Quick markdown lint (changed files only)
        run: |
          npm install -g markdownlint-cli

          # Create minimal config
          cat > .markdownlint.json << 'EOF'
          {
            "MD013": false, "MD033": false, "MD034": false,
            "MD036": false, "MD041": false
          }
          EOF

          # Only lint changed files for speed
          CHANGED_MD=$(git diff --name-only HEAD~1 HEAD | \
            grep -E '\.(md|markdown)$' | head -10)
          if [[ -n "$CHANGED_MD" ]]; then
            echo "📝 Linting: $CHANGED_MD"
            echo "$CHANGED_MD" | xargs markdownlint \
              --config .markdownlint.json || echo "⚠️ Lint issues found"
          else
            echo "⚡ No markdown changes to lint"
          fi

  # Optimized build job with parallel language processing
  build:
    name: 🏗️ Build Sites
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.should-build == 'true'
    strategy:
      matrix:
        language: [ko, en, ar]
      fail-fast: false
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 💎 Setup Ruby (with cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: 📦 Setup Pages
        id: pages
        uses: actions/configure-pages@v4
        if: needs.detect-changes.outputs.should-deploy == 'true'

      - name: 🔍 Check if language should be built
        id: should-build-lang
        run: |
          BUILD_LANGUAGES="${{ needs.detect-changes.outputs.build-languages }}"
          CURRENT_LANG="${{ matrix.language }}"

          if [[ "$BUILD_LANGUAGES" == *"$CURRENT_LANG"* ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "✅ Building $CURRENT_LANG"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping $CURRENT_LANG"
          fi

      - name: 🏗️ Build ${{ matrix.language }} site
        if: steps.should-build-lang.outputs.should-build == 'true'
        run: |
          LANG="${{ matrix.language }}"
          IS_DEPLOY="${{ needs.detect-changes.outputs.should-deploy }}"

          echo "🏗️ Building $LANG site..."

          # Use production env for main branch, development for others
          if [[ "$IS_DEPLOY" == "true" ]]; then
            JEKYLL_ENV=production
            LIMIT_POSTS=""
          else
            JEKYLL_ENV=development
            LIMIT_POSTS="--limit_posts 20"
          fi

          JEKYLL_ENV=$JEKYLL_ENV bundle exec jekyll build \
            --config _config.yml,_config-${LANG}.yml \
            --destination _site_${LANG} \
            $LIMIT_POSTS \
            --verbose

          echo "✅ $LANG site built successfully"

      - name: 📤 Upload ${{ matrix.language }} artifact
        if: >
          steps.should-build-lang.outputs.should-build == 'true' &&
          needs.detect-changes.outputs.should-deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ matrix.language }}
          path: _site_${{ matrix.language }}
          retention-days: 1

  # Single unified site deploy (only on main branch)
  deploy:
    name: 🚀 Deploy Single Site
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.should-deploy == 'true'
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 📦 Setup Pages
        uses: actions/configure-pages@v4

      - name: 📥 Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 🔗 Deploy main site (single language approach)
        run: |
          BUILD_LANGUAGES="${{ needs.detect-changes.outputs.build-languages }}"
          DEPLOY_LANGUAGE="${{ needs.detect-changes.outputs.deploy-language }}"
          
          echo "🔗 Preparing single site for deployment..."
          echo "Build languages: $BUILD_LANGUAGES"
          echo "Deploy language: $DEPLOY_LANGUAGE"
          
          # Create site directory
          mkdir -p _site
          
          # 배포할 언어의 사이트를 루트에 복사
          if [[ -d "artifacts/site-$DEPLOY_LANGUAGE" ]]; then
            echo "📁 Deploying $DEPLOY_LANGUAGE site to root"
            cp -r artifacts/site-$DEPLOY_LANGUAGE/* _site/
            echo "✅ $DEPLOY_LANGUAGE site deployed successfully"
          else
            echo "❌ No site artifacts found for $DEPLOY_LANGUAGE!"
            echo "Available artifacts:"
            ls -la artifacts/ || echo "No artifacts directory"
            
            # 폴백: 사용 가능한 첫 번째 언어 사용
            for lang in ko en ar; do
              if [[ -d "artifacts/site-$lang" ]]; then
                echo "🔄 Fallback: Using $lang site"
                cp -r artifacts/site-$lang/* _site/
                echo "✅ $lang site deployed as fallback"
                break
              fi
            done
            
            # 여전히 없으면 에러
            if [[ ! -f "_site/index.html" ]]; then
              echo "❌ No valid site found for deployment!"
              exit 1
            fi
          fi
          
          # 필수 파일 검증
          if [[ ! -f "_site/index.html" ]]; then
            echo "❌ index.html not found!"
            ls -la _site/ || echo "No _site directory"
            exit 1
          fi
          
          echo "✅ Site prepared for deployment"

      - name: 📊 Verify site structure
        run: |
          echo "📊 Final site structure:"
          find _site -type f -name "*.html" | head -10
          echo ""
          echo "📄 Root files:"
          ls -la _site/ | head -10
          echo ""
          echo "📈 Site statistics:"
          echo "  HTML files: $(find _site -name "*.html" | wc -l)"
          echo "  CSS files: $(find _site -name "*.css" | wc -l)"
          echo "  JS files: $(find _site -name "*.js" | wc -l)"
          echo "  Total files: $(find _site -type f | wc -l)"
          echo ""
          echo "🌐 URL structure verification:"
          find _site -name "*.html" | grep -E "(ko|en|ar)" | head -5

      - name: 📤 Upload site
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Enhanced verification
  verify:
    name: ✅ Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, detect-changes]
    if: needs.detect-changes.outputs.should-deploy == 'true'
    steps:
      - name: 🔍 Enhanced verification
        run: |
          echo "🔍 Verifying deployment..."
          BASE_URL="${{ needs.deploy.outputs.page_url }}"
          BASE_URL="${BASE_URL:-https://thakicloud.github.io}"
          DEPLOY_LANGUAGE="${{ needs.detect-changes.outputs.deploy-language }}"

          echo "🌐 Deployed language: $DEPLOY_LANGUAGE"
          echo "🔗 Base URL: $BASE_URL"

          # Wait for propagation
          echo "⏳ Waiting for DNS propagation..."
          sleep 30

          # Main site health check
          echo "🏠 Testing main site..."
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL" || echo "000")
          echo "Main site status: $MAIN_STATUS"

          # Test language-specific URLs
          echo "🌍 Testing language URLs..."
          for lang in ko en ar; do
            lang_url="${BASE_URL}/${lang}/"
            lang_status=$(curl -s -o /dev/null -w "%{http_code}" "$lang_url" || echo "000")
            echo "$lang URL ($lang_url): $lang_status"
          done

          # Basic content verification
          if [[ "$MAIN_STATUS" == "200" ]]; then
            echo "📝 Testing main content..."
            content_check=$(curl -s "$BASE_URL" | grep -i "thaki" || echo "")
            if [[ -n "$content_check" ]]; then
              echo "✅ Content verification passed"
            else
              echo "⚠️ Content verification failed"
            fi
          fi

          echo "✅ Deployment verification completed"
          echo "🎯 Main site ($DEPLOY_LANGUAGE): $MAIN_STATUS"
