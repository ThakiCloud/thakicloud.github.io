---
name: Unified Build & Deploy

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUBY_VERSION: '3.2'
  NODE_VERSION: '18'
  DEFAULT_LANGUAGE: 'ko' # ê¸°ë³¸ ì–¸ì–´ ì„¤ì •

jobs:
  detect-changes:
    name: ğŸ” Detect Changes & Plan
    runs-on: ubuntu-latest
    outputs:
      # Language changes
      korean-changed: ${{ steps.changes.outputs.korean }}
      english-changed: ${{ steps.changes.outputs.english }}
      arabic-changed: ${{ steps.changes.outputs.arabic }}
      global-changed: ${{ steps.changes.outputs.global }}

      # Build plan
      should-build: ${{ steps.plan.outputs.should-build }}
      should-deploy: ${{ steps.plan.outputs.should-deploy }}
      should-lint: ${{ steps.plan.outputs.should-lint }}
      build-languages: ${{ steps.plan.outputs.build-languages }}
      build-mode: ${{ steps.plan.outputs.build-mode }}
      deploy-language: ${{ steps.plan.outputs.deploy-language }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            korean:
              - '_posts/ko/**'
              - '_pages/ko/**'
              - '_config-ko.yml'
            english:
              - '_posts/en/**'
              - '_pages/en/**'
              - '_config-en.yml'
            arabic:
              - '_posts/ar/**'
              - '_pages/ar/**'
              - '_config-ar.yml'
            global:
              - '_config.yml'
              - '_data/**'
              - '_includes/**'
              - '_layouts/**'
              - '_sass/**'
              - 'assets/**'
              - 'index.html'
              - '.github/workflows/**'
              - 'Gemfile*'

      - name: ğŸ“‹ Create build plan
        id: plan
        run: |
          KOREAN="${{ steps.changes.outputs.korean }}"
          ENGLISH="${{ steps.changes.outputs.english }}"
          ARABIC="${{ steps.changes.outputs.arabic }}"
          GLOBAL="${{ steps.changes.outputs.global }}"
          IS_MAIN="${{ github.ref == 'refs/heads/main' }}"
          IS_PR="${{ github.event_name == 'pull_request' }}"
          DEFAULT_LANG="${{ env.DEFAULT_LANGUAGE }}"

          echo "ğŸ”§ Planning build strategy..."
          echo "  Korean: $KOREAN | English: $ENGLISH | Arabic: $ARABIC"
          echo "  Global: $GLOBAL | Main branch: $IS_MAIN | PR: $IS_PR"
          echo "  Default language: $DEFAULT_LANG"
          
          # ë¹Œë“œ ì–¸ì–´ ê²°ì • ë¡œì§ ê°œì„ 
          BUILD_LANGUAGES=""
          if [[ "$GLOBAL" == "true" ]]; then
            BUILD_LANGUAGES="ko,en,ar"
            BUILD_MODE="full"
            echo "ğŸ”„ Global changes - building all languages"
          else
            BUILD_MODE="incremental"
            # ë³€ê²½ëœ ì–¸ì–´ë§Œ ë¹Œë“œ ëª©ë¡ì— ì¶”ê°€
            [[ "$KOREAN" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}ko,"
            [[ "$ENGLISH" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}en,"
            [[ "$ARABIC" == "true" ]] && BUILD_LANGUAGES="${BUILD_LANGUAGES}ar,"
            BUILD_LANGUAGES=${BUILD_LANGUAGES%,}

            # ë¹Œë“œí•  ì–¸ì–´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì–¸ì–´ ì‚¬ìš©
            if [[ -z "$BUILD_LANGUAGES" ]]; then
              BUILD_LANGUAGES="$DEFAULT_LANG"
              echo "âš¡ No specific changes, defaulting to $DEFAULT_LANG"
            else
              echo "âš¡ Incremental build for: $BUILD_LANGUAGES"
            fi
          fi

          # ë°°í¬ ì–¸ì–´ ê²°ì • (ê¸°ë³¸ ì–¸ì–´ ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸)
          DEPLOY_LANGUAGE="$DEFAULT_LANG"
          if [[ "$BUILD_LANGUAGES" != *"$DEFAULT_LANG"* ]]; then
            DEPLOY_LANGUAGE=$(echo "$BUILD_LANGUAGES" | cut -d',' -f1)
            echo "âš ï¸ Default language not in build list, using $DEPLOY_LANGUAGE for deployment"
          fi

          # Set outputs
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "should-deploy=$IS_MAIN" >> $GITHUB_OUTPUT
          echo "should-lint=true" >> $GITHUB_OUTPUT
          echo "build-languages=$BUILD_LANGUAGES" >> $GITHUB_OUTPUT
          echo "build-mode=$BUILD_MODE" >> $GITHUB_OUTPUT
          echo "deploy-language=$DEPLOY_LANGUAGE" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Build plan:"
          echo "  Languages: $BUILD_LANGUAGES"
          echo "  Mode: $BUILD_MODE"
          echo "  Deploy language: $DEPLOY_LANGUAGE"
          echo "  Will deploy: $IS_MAIN"

  # Fast linting job that runs in parallel
  lint:
    name: ğŸ§¹ Quick Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-lint == 'true'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’ Setup Ruby (with cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: ğŸ“¦ Setup Node.js (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ§¹ Jekyll doctor
        run: bundle exec jekyll doctor

      - name: ğŸ“ Quick markdown lint (changed files only)
        run: |
          npm install -g markdownlint-cli

          # Create minimal config
          cat > .markdownlint.json << 'EOF'
          {
            "MD013": false, "MD033": false, "MD034": false,
            "MD036": false, "MD041": false
          }
          EOF

          # Only lint changed files for speed
          CHANGED_MD=$(git diff --name-only HEAD~1 HEAD | \
            grep -E '\.(md|markdown)$' | head -10)
          if [[ -n "$CHANGED_MD" ]]; then
            echo "ğŸ“ Linting: $CHANGED_MD"
            echo "$CHANGED_MD" | xargs markdownlint \
              --config .markdownlint.json || echo "âš ï¸ Lint issues found"
          else
            echo "âš¡ No markdown changes to lint"
          fi

  # Optimized build job with parallel language processing
  build:
    name: ğŸ—ï¸ Build Sites
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.should-build == 'true'
    strategy:
      matrix:
        language: [ko, en, ar]
      fail-fast: false
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’ Setup Ruby (with cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: ğŸ“¦ Setup Pages
        id: pages
        uses: actions/configure-pages@v4
        if: needs.detect-changes.outputs.should-deploy == 'true'

      - name: ğŸ” Check if language should be built
        id: should-build-lang
        run: |
          BUILD_LANGUAGES="${{ needs.detect-changes.outputs.build-languages }}"
          CURRENT_LANG="${{ matrix.language }}"

          if [[ "$BUILD_LANGUAGES" == *"$CURRENT_LANG"* ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Building $CURRENT_LANG"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping $CURRENT_LANG"
          fi

      - name: ğŸ—ï¸ Build ${{ matrix.language }} site
        if: steps.should-build-lang.outputs.should-build == 'true'
        run: |
          LANG="${{ matrix.language }}"
          IS_DEPLOY="${{ needs.detect-changes.outputs.should-deploy }}"

          echo "ğŸ—ï¸ Building $LANG site..."

          # Use production env for main branch, development for others
          if [[ "$IS_DEPLOY" == "true" ]]; then
            JEKYLL_ENV=production
            LIMIT_POSTS=""
          else
            JEKYLL_ENV=development
            LIMIT_POSTS="--limit_posts 20"
          fi

          JEKYLL_ENV=$JEKYLL_ENV bundle exec jekyll build \
            --config _config.yml,_config-${LANG}.yml \
            --destination _site_${LANG} \
            $LIMIT_POSTS \
            --verbose

          echo "âœ… $LANG site built successfully"

      - name: ğŸ“¤ Upload ${{ matrix.language }} artifact
        if: >
          steps.should-build-lang.outputs.should-build == 'true' &&
          needs.detect-changes.outputs.should-deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: site-${{ matrix.language }}
          path: _site_${{ matrix.language }}
          retention-days: 1

  # Single unified site deploy (only on main branch)
  deploy:
    name: ğŸš€ Deploy Single Site
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.should-deploy == 'true'
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ”— Deploy main site (single language approach)
        run: |
          BUILD_LANGUAGES="${{ needs.detect-changes.outputs.build-languages }}"
          DEPLOY_LANGUAGE="${{ needs.detect-changes.outputs.deploy-language }}"
          
          echo "ğŸ”— Preparing single site for deployment..."
          echo "Build languages: $BUILD_LANGUAGES"
          echo "Deploy language: $DEPLOY_LANGUAGE"
          
          # Create site directory
          mkdir -p _site
          
          # ë°°í¬í•  ì–¸ì–´ì˜ ì‚¬ì´íŠ¸ë¥¼ ë£¨íŠ¸ì— ë³µì‚¬
          if [[ -d "artifacts/site-$DEPLOY_LANGUAGE" ]]; then
            echo "ğŸ“ Deploying $DEPLOY_LANGUAGE site to root"
            cp -r artifacts/site-$DEPLOY_LANGUAGE/* _site/
            echo "âœ… $DEPLOY_LANGUAGE site deployed successfully"
          else
            echo "âŒ No site artifacts found for $DEPLOY_LANGUAGE!"
            echo "Available artifacts:"
            ls -la artifacts/ || echo "No artifacts directory"
            
            # í´ë°±: ì‚¬ìš© ê°€ëŠ¥í•œ ì²« ë²ˆì§¸ ì–¸ì–´ ì‚¬ìš©
            for lang in ko en ar; do
              if [[ -d "artifacts/site-$lang" ]]; then
                echo "ğŸ”„ Fallback: Using $lang site"
                cp -r artifacts/site-$lang/* _site/
                echo "âœ… $lang site deployed as fallback"
                break
              fi
            done
            
            # ì—¬ì „íˆ ì—†ìœ¼ë©´ ì—ëŸ¬
            if [[ ! -f "_site/index.html" ]]; then
              echo "âŒ No valid site found for deployment!"
              exit 1
            fi
          fi
          
          # í•„ìˆ˜ íŒŒì¼ ê²€ì¦
          if [[ ! -f "_site/index.html" ]]; then
            echo "âŒ index.html not found!"
            ls -la _site/ || echo "No _site directory"
            exit 1
          fi
          
          echo "âœ… Site prepared for deployment"

      - name: ğŸ“Š Verify site structure
        run: |
          echo "ğŸ“Š Final site structure:"
          find _site -type f -name "*.html" | head -10
          echo ""
          echo "ğŸ“„ Root files:"
          ls -la _site/ | head -10
          echo ""
          echo "ğŸ“ˆ Site statistics:"
          echo "  HTML files: $(find _site -name "*.html" | wc -l)"
          echo "  CSS files: $(find _site -name "*.css" | wc -l)"
          echo "  JS files: $(find _site -name "*.js" | wc -l)"
          echo "  Total files: $(find _site -type f | wc -l)"
          echo ""
          echo "ğŸŒ URL structure verification:"
          find _site -name "*.html" | grep -E "(ko|en|ar)" | head -5

      - name: ğŸ“¤ Upload site
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Enhanced verification
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, detect-changes]
    if: needs.detect-changes.outputs.should-deploy == 'true'
    steps:
      - name: ğŸ” Enhanced verification
        run: |
          echo "ğŸ” Verifying deployment..."
          BASE_URL="${{ needs.deploy.outputs.page_url }}"
          BASE_URL="${BASE_URL:-https://thakicloud.github.io}"
          DEPLOY_LANGUAGE="${{ needs.detect-changes.outputs.deploy-language }}"

          echo "ğŸŒ Deployed language: $DEPLOY_LANGUAGE"
          echo "ğŸ”— Base URL: $BASE_URL"

          # Wait for propagation
          echo "â³ Waiting for DNS propagation..."
          sleep 30

          # Main site health check
          echo "ğŸ  Testing main site..."
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL" || echo "000")
          echo "Main site status: $MAIN_STATUS"

          # Test language-specific URLs
          echo "ğŸŒ Testing language URLs..."
          for lang in ko en ar; do
            lang_url="${BASE_URL}/${lang}/"
            lang_status=$(curl -s -o /dev/null -w "%{http_code}" "$lang_url" || echo "000")
            echo "$lang URL ($lang_url): $lang_status"
          done

          # Basic content verification
          if [[ "$MAIN_STATUS" == "200" ]]; then
            echo "ğŸ“ Testing main content..."
            content_check=$(curl -s "$BASE_URL" | grep -i "thaki" || echo "")
            if [[ -n "$content_check" ]]; then
              echo "âœ… Content verification passed"
            else
              echo "âš ï¸ Content verification failed"
            fi
          fi

          echo "âœ… Deployment verification completed"
          echo "ğŸ¯ Main site ($DEPLOY_LANGUAGE): $MAIN_STATUS"
