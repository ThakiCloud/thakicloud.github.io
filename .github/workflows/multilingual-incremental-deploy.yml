name: Multilingual Incremental Deploy

on:
  push:
    branches: [ main ]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
  pull_request:
    branches: [ main ]
    paths:
      - '_posts/**'
      - '_pages/**'
      - '_config*.yml'
      - '_data/**'
      - '_includes/**'
      - '_layouts/**'
      - '_sass/**'
      - 'assets/**'
      - 'index.html'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  detect-language-changes:
    name: ğŸ” Detect Language Changes
    runs-on: ubuntu-latest
    outputs:
      korean-changed: ${{ steps.changes.outputs.korean }}
      english-changed: ${{ steps.changes.outputs.english }}
      arabic-changed: ${{ steps.changes.outputs.arabic }}
      global-changed: ${{ steps.changes.outputs.global }}
      should-build-all: ${{ steps.decision.outputs.should-build-all }}
      build-languages: ${{ steps.decision.outputs.build-languages }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changed files by language
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            korean:
              - '_posts/ko/**'
              - '_pages/ko/**'
              - '_config-ko.yml'
            english:
              - '_posts/en/**'
              - '_pages/en/**'
              - '_config-en.yml'
            arabic:
              - '_posts/ar/**'
              - '_pages/ar/**'
              - '_config-ar.yml'
            global:
              - '_config.yml'
              - '_data/**'
              - '_includes/**'
              - '_layouts/**'
              - '_sass/**'
              - 'assets/**'
              - 'index.html'
              - '.github/workflows/**'

      - name: ğŸ¤” Build decision
        id: decision
        run: |
          KOREAN="${{ steps.changes.outputs.korean }}"
          ENGLISH="${{ steps.changes.outputs.english }}"
          ARABIC="${{ steps.changes.outputs.arabic }}"
          GLOBAL="${{ steps.changes.outputs.global }}"
          
          BUILD_LANGUAGES=""
          
          if [[ "$GLOBAL" == "true" ]]; then
            echo "should-build-all=true" >> $GITHUB_OUTPUT
            echo "build-languages=ko,en,ar" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Global changes detected - building all languages"
          else
            echo "should-build-all=false" >> $GITHUB_OUTPUT
            
            if [[ "$KOREAN" == "true" ]]; then
              BUILD_LANGUAGES="${BUILD_LANGUAGES}ko,"
              echo "ğŸ‡°ğŸ‡· Korean changes detected"
            fi
            
            if [[ "$ENGLISH" == "true" ]]; then
              BUILD_LANGUAGES="${BUILD_LANGUAGES}en,"
              echo "ğŸ‡ºğŸ‡¸ English changes detected"
            fi
            
            if [[ "$ARABIC" == "true" ]]; then
              BUILD_LANGUAGES="${BUILD_LANGUAGES}ar,"
              echo "ğŸ‡¸ğŸ‡¦ Arabic changes detected"
            fi
            
            # Remove trailing comma
            BUILD_LANGUAGES=${BUILD_LANGUAGES%,}
            
            if [[ -z "$BUILD_LANGUAGES" ]]; then
              BUILD_LANGUAGES="ko"
              echo "âš¡ No specific language changes, defaulting to Korean"
            fi
            
            echo "build-languages=$BUILD_LANGUAGES" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Languages to build: $BUILD_LANGUAGES"
          fi

  build-multilingual:
    name: ğŸ—ï¸ Build Multilingual Sites
    runs-on: ubuntu-latest
    needs: detect-language-changes
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: ğŸ“¦ Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: ğŸ—ï¸ Build sites based on changes
        run: |
          BUILD_ALL="${{ needs.detect-language-changes.outputs.should-build-all }}"
          BUILD_LANGUAGES="${{ needs.detect-language-changes.outputs.build-languages }}"
          
          echo "ğŸ”§ Build configuration:"
          echo "  Build all: $BUILD_ALL"
          echo "  Languages: $BUILD_LANGUAGES"
          
          # Create base site directory
          mkdir -p _site
          
          # Always build the main index (language selector)
          echo "ğŸ  Building main index page..."
          cp index.html _site/
          
          # Build Korean site (always build as default)
          if [[ "$BUILD_LANGUAGES" == *"ko"* ]] || [[ "$BUILD_ALL" == "true" ]]; then
            echo "ğŸ‡°ğŸ‡· Building Korean site..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-ko.yml \
              --destination _site_ko \
              --verbose --limit_posts 50
            
            # Copy Korean content to main site root (default language)
            cp -r _site_ko/* _site/
            
            # Also create /ko/ directory
            mkdir -p _site/ko
            cp -r _site_ko/* _site/ko/
            
            rm -rf _site_ko
            echo "âœ… Korean site built successfully"
          else
            echo "â­ï¸ Skipping Korean site build"
          fi
          
          # Build English site
          if [[ "$BUILD_LANGUAGES" == *"en"* ]] || [[ "$BUILD_ALL" == "true" ]]; then
            echo "ğŸ‡ºğŸ‡¸ Building English site..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-en.yml \
              --destination _site_en \
              --verbose --limit_posts 50
            
            mkdir -p _site/en
            cp -r _site_en/* _site/en/
            rm -rf _site_en
            echo "âœ… English site built successfully"
          else
            echo "â­ï¸ Skipping English site build"
          fi
          
          # Build Arabic site
          if [[ "$BUILD_LANGUAGES" == *"ar"* ]] || [[ "$BUILD_ALL" == "true" ]]; then
            echo "ğŸ‡¸ğŸ‡¦ Building Arabic site..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-ar.yml \
              --destination _site_ar \
              --verbose --limit_posts 50
            
            mkdir -p _site/ar
            cp -r _site_ar/* _site/ar/
            rm -rf _site_ar
            echo "âœ… Arabic site built successfully"
          else
            echo "â­ï¸ Skipping Arabic site build"
          fi

      - name: ğŸ”— Generate language-specific search indexes
        run: |
          BUILD_LANGUAGES="${{ needs.detect-language-changes.outputs.build-languages }}"
          
          echo "ğŸ” Generating search indexes for languages: $BUILD_LANGUAGES"
          
          # Generate Korean search index
          if [[ "$BUILD_LANGUAGES" == *"ko"* ]] || [[ "${{ needs.detect-language-changes.outputs.should-build-all }}" == "true" ]]; then
            echo "ğŸ‡°ğŸ‡· Generating Korean search index..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-ko.yml \
              --destination _temp_ko \
              --verbose --limit_posts 1000
            
            if [[ -f "_temp_ko/search.json" ]]; then
              mkdir -p _site/ko/assets/js
              cp _temp_ko/search.json _site/ko/assets/js/search-ko.json
              cp _temp_ko/search.json _site/assets/js/search-ko.json 2>/dev/null || true
            fi
            rm -rf _temp_ko
          fi
          
          # Generate English search index
          if [[ "$BUILD_LANGUAGES" == *"en"* ]] || [[ "${{ needs.detect-language-changes.outputs.should-build-all }}" == "true" ]]; then
            echo "ğŸ‡ºğŸ‡¸ Generating English search index..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-en.yml \
              --destination _temp_en \
              --verbose --limit_posts 1000
            
            if [[ -f "_temp_en/search.json" ]]; then
              mkdir -p _site/en/assets/js
              cp _temp_en/search.json _site/en/assets/js/search-en.json
            fi
            rm -rf _temp_en
          fi
          
          # Generate Arabic search index
          if [[ "$BUILD_LANGUAGES" == *"ar"* ]] || [[ "${{ needs.detect-language-changes.outputs.should-build-all }}" == "true" ]]; then
            echo "ğŸ‡¸ğŸ‡¦ Generating Arabic search index..."
            JEKYLL_ENV=production bundle exec jekyll build \
              --config _config.yml,_config-ar.yml \
              --destination _temp_ar \
              --verbose --limit_posts 1000
            
            if [[ -f "_temp_ar/search.json" ]]; then
              mkdir -p _site/ar/assets/js
              cp _temp_ar/search.json _site/ar/assets/js/search-ar.json
            fi
            rm -rf _temp_ar
          fi

      - name: ğŸ“Š Verify site structure
        run: |
          echo "ğŸ“Š Final site structure:"
          find _site -type d -maxdepth 3 | sort
          
          echo ""
          echo "ğŸ“„ Key files check:"
          ls -la _site/ | head -10
          
          if [[ -d "_site/ko" ]]; then
            echo "ğŸ‡°ğŸ‡· Korean site files:"
            ls -la _site/ko/ | head -5
          fi
          
          if [[ -d "_site/en" ]]; then
            echo "ğŸ‡ºğŸ‡¸ English site files:"
            ls -la _site/en/ | head -5
          fi
          
          if [[ -d "_site/ar" ]]; then
            echo "ğŸ‡¸ğŸ‡¦ Arabic site files:"
            ls -la _site/ar/ | head -5
          fi

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-multilingual
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  post-deploy-verification:
    name: âœ… Post-Deploy Verification
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [deploy, detect-language-changes]
    steps:
      - name: ğŸ” Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          
          BASE_URL="${{ steps.deployment.outputs.page_url || 'https://thakicloud.github.io' }}"
          BUILD_LANGUAGES="${{ needs.detect-language-changes.outputs.build-languages }}"
          
          echo "ğŸŒ Base URL: $BASE_URL"
          echo "ğŸ—ï¸ Built languages: $BUILD_LANGUAGES"
          
          # Wait a bit for deployment to propagate
          sleep 30
          
          # Test main page
          echo "ğŸ  Testing main page..."
          curl -s -o /dev/null -w "%{http_code}" "$BASE_URL" || echo "Main page test completed"
          
          # Test language-specific pages
          if [[ "$BUILD_LANGUAGES" == *"ko"* ]]; then
            echo "ğŸ‡°ğŸ‡· Testing Korean site..."
            curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/ko/" || echo "Korean site test completed"
          fi
          
          if [[ "$BUILD_LANGUAGES" == *"en"* ]]; then
            echo "ğŸ‡ºğŸ‡¸ Testing English site..."
            curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/en/" || echo "English site test completed"
          fi
          
          if [[ "$BUILD_LANGUAGES" == *"ar"* ]]; then
            echo "ğŸ‡¸ğŸ‡¦ Testing Arabic site..."
            curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/ar/" || echo "Arabic site test completed"
          fi
          
          echo "âœ… Deployment verification completed"
