name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Filter posts by category (limit large categories)
        run: |
          echo "=== Filtering posts to reduce build size ==="
          
          # ëŒ€ëŸ‰ ì¹´í…Œê³ ë¦¬ ëª©ë¡ (ìµœì‹  15ê°œë§Œ ìœ ì§€)
          LIMIT_CATEGORIES=("agentops" "tutorials" "dev" "owm" "research")
          KEEP_COUNT=15
          
          total_moved=0
          
          for lang in ko en ar; do
            for category in "${LIMIT_CATEGORIES[@]}"; do
              dir="_posts/$lang/$category"
              if [ -d "$dir" ]; then
                # í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í¬ìŠ¤íŠ¸ ê°œìˆ˜ í™•ì¸
                post_count=$(ls -1 "$dir"/*.md 2>/dev/null | wc -l)
                echo "[$lang/$category] Found $post_count posts"
                
                if [ "$post_count" -gt "$KEEP_COUNT" ]; then
                  # íŒŒì¼ì„ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (íŒŒì¼ëª…ì˜ ë‚ ì§œ ê¸°ì¤€, ìµœì‹ ìˆœ)
                  # ìµœì‹  15ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ ë°±ì—…ìœ¼ë¡œ ì´ë™
                  ls -1 "$dir"/*.md 2>/dev/null | sort -r | tail -n +$((KEEP_COUNT + 1)) | while read file; do
                    mkdir -p "_posts_backup/$lang/$category"
                    mv "$file" "_posts_backup/$lang/$category/"
                    ((total_moved++))
                  done
                  
                  remaining=$(ls -1 "$dir"/*.md 2>/dev/null | wc -l)
                  moved=$((post_count - remaining))
                  echo "[$lang/$category] Kept $remaining posts, moved $moved posts to backup"
                fi
              fi
            done
          done
          
          echo ""
          echo "=== Filtering Summary ==="
          echo "Total posts moved to backup: $total_moved"
          echo "Remaining posts will be built"
          
          # ìµœì¢… í†µê³„
          echo ""
          echo "=== Final post count by category ==="
          for lang in ko en ar; do
            echo "Language: $lang"
            for cat_dir in _posts/$lang/*/; do
              if [ -d "$cat_dir" ]; then
                category=$(basename "$cat_dir")
                count=$(ls -1 "$cat_dir"/*.md 2>/dev/null | wc -l)
                echo "  - $category: $count posts"
              fi
            done
          done
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          cache-version: 0
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
