name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: üìä Filter posts by category (limit large categories)
        run: |
          echo "=== Filtering posts to reduce build size ==="
          
          # ÎåÄÎüâ Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù (ÏµúÏã† 15Í∞úÎßå Ïú†ÏßÄ)
          LIMIT_CATEGORIES=("agentops" "tutorials" "dev" "owm" "research")
          KEEP_COUNT=15
          
          for lang in ko en ar; do
            for category in "${LIMIT_CATEGORIES[@]}"; do
              dir="_posts/$lang/$category"
              if [ -d "$dir" ]; then
                # Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Ìè¨Ïä§Ìä∏ Í∞úÏàò ÌôïÏù∏
                post_count=$(find "$dir" -maxdepth 1 -name "*.md" -type f | wc -l)
                echo "[$lang/$category] Found $post_count posts"
                
                if [ "$post_count" -gt "$KEEP_COUNT" ]; then
                  # Î∞±ÏóÖ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
                  mkdir -p "_posts_backup/$lang/$category"
                  
                  # ÌååÏùºÏùÑ ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÌååÏùºÎ™Ö Í∏∞Ï§Ä, ÏµúÏã†Ïàú)
                  # ÏµúÏã† 15Í∞úÎ•º Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄÎ•º Î∞±ÏóÖÏúºÎ°ú Ïù¥Îèô
                  find "$dir" -maxdepth 1 -name "*.md" -type f | sort -r | tail -n +$((KEEP_COUNT + 1)) > /tmp/files_to_move.txt
                  
                  # ÌååÏùº Ïù¥Îèô
                  while IFS= read -r file; do
                    mv "$file" "_posts_backup/$lang/$category/" || echo "Warning: failed to move $file"
                  done < /tmp/files_to_move.txt
                  
                  # Í≤∞Í≥º ÌôïÏù∏
                  remaining=$(find "$dir" -maxdepth 1 -name "*.md" -type f | wc -l)
                  moved=$((post_count - remaining))
                  echo "[$lang/$category] Kept $remaining posts, moved $moved posts to backup"
                fi
              fi
            done
          done
          
          echo ""
          echo "=== Filtering Summary ==="
          total_backup=$(find _posts_backup -name "*.md" -type f 2>/dev/null | wc -l)
          echo "Total posts moved to backup: $total_backup"
          echo "Remaining posts will be built"
          
          # ÏµúÏ¢Ö ÌÜµÍ≥Ñ
          echo ""
          echo "=== Final post count by category ==="
          for lang in ko en ar; do
            echo "Language: $lang"
            for cat_dir in _posts/$lang/*/; do
              if [ -d "$cat_dir" ]; then
                category=$(basename "$cat_dir")
                count=$(find "$cat_dir" -maxdepth 1 -name "*.md" -type f | wc -l)
                if [ "$count" -gt 0 ]; then
                  echo "  - $category: $count posts"
                fi
              fi
            done
          done
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          cache-version: 0
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
